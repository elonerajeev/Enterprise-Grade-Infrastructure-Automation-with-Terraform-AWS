name: CI/CD - Build and Push Docker Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    # ğŸ“¦ Step 1: Checkout repository code
    - name: ğŸ“¦ Checkout Repository Code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # optional: gets full history for better logs

    # âš™ï¸ Step 2: Set up Docker Buildx
    - name: âš™ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # ğŸ” Step 3: Authenticate with DockerHub using GitHub Secrets
    - name: ğŸ” Log in to DockerHub (using secrets)
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # ğŸ—ï¸ Step 4: Build Docker Image from production Dockerfile
    - name: ğŸ—ï¸ Build Docker Image from app/Dockerfile.prod
      run: |
        echo "ğŸ“¢ Starting Docker build..."
        docker build -t elonerajeev/infra-app:latest -f app/Dockerfile.prod ./app
        echo "âœ… Docker image built successfully."

    # â˜ï¸ Step 5: Push Docker image to DockerHub
    - name: â˜ï¸ Push Docker Image to DockerHub
      run: |
        echo "ğŸ“¢ Pushing Docker image to DockerHub..."
        docker push elonerajeev/infra-app:latest
        echo "âœ… Docker image pushed to DockerHub successfully."
